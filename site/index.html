<html>
    <head>
        <title>Chat Bot</title>
        <style>
            #chat_output {
                resize: none;
                width: 60%;
                height: 60%;
            }
            #chat_input {
                width: 30%;
                height: 20%;
            }
        </style>
        <script type="text/javascript">
            // Initialize connection to the backend server
            var socket = new WebSocket('{{ hostname }}');

            // create a variable to track the chat log, without the You: and Bot: prefixes
            var chatLog = "";

            // variable is only true if connected via websocket to the backend server
            var socketConnected = false;

            socket.addEventListener('open', function (event) {
                socketConnected = true;
                socket.send(chatLog);
            });

            socket.addEventListener('close', function (event) {
                socket_connected = false;
                
                // try connecting 3 times to the backend server, with 5 second intervals
                // but only if not connected
                var socket = new WebSocket('{{ hostname }}');
                for(i = 0; i < 2; i++){
                    if(socketConnected == true){break;}
                    setTimeout(() => {var socket = new WebSocket('{{ hostname }}');}, 5000);
                }
            });

            // when message is received from the backend server, print it to the chat output
            socket.onmessage = function (event) {
                chatLog += event.data + "\n";
                document.getElementById('chat_output').value += 'Chatbot: ' + event.data + '\n';
                
            };

            // when the user submits the chat input, send the message to the backend server
            function sendMessage(event) {
                
                var message = document.getElementById('chat_input').value;
                if (message != '') {
                    chat_input.value = '';
                    chatLog += message + "\n";
                    document.getElementById('chat_output').value += 'You: ' + message + '\n';
                    if (socketConnected) {
                        socket.send(message);
                    } else {
                        alert('You are not connected to the backend server. Please refresh the page. Or check that the backend server is running and all is configured properly.');
                    }
                } else {
                    alert('Please enter a message.');
                }
            }

        </script>
    </head>
    <body>
        <div>
            <textarea id="chat_output" readonly></textarea>
        </div>
        <div>
            <textarea id="chat_input" placeholder="Type your message here..."></textarea>
        </div>
        <div>
            <button id="chat_button" onclick="sendMessage()">Send</button>
        </div>
    </body>
</html>