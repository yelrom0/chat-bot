<html>
    <head>
        <title>Chat Bot</title>
        <style>
            #chat_output {
                resize: none;
                width: 60%;
                height: 60%;
            }
            #chat_input {
                width: 30%;
                height: 20%;
            }
        </style>
        <script type="text/javascript">
            // create a variable to track the chat log, without the You: and Bot: prefixes
            var chatLog = "";

            // variable is only true if connected via websocket to the backend server
            var socketConnected = false;
            var socket;
            
            function connect(){
                // Initialize connection to the backend server
                socket = new WebSocket('{{ hostname }}');

                socket.onopen = function(e){
                    console.log("Connection to the backend server opened");
                    socketConnected = true;
                    socket.send(chatLog);
                }
            }

            connect();

            // if socket dies, attempt reconnection
            socket.onclose = function(e){
                socketConnected = false;
                console.log('Socket is closed. Reconnect will be attempted in 1 second. Reason: ' + e.reason);
                setInterval(function() {
                    connect();
                }, 1000);
            }

            // when message is received from the backend server, print it to the chat output as long as it's not a keep alive message.
            socket.onmessage = function (event) {
                if (event.data){
                    chatLog += event.data + "\n";
                    ocument.getElementById('chat_output').value += 'Chatbot: ' + event.data + '\n';
                }
                
            };

            // when there's a websocket error, print it to the log, then close the socket (thereby attempting a reconnect)
            socket.onerror = function(error){
                console.log('WebSocket Error: ' + error);
                socket.close();
            }

            // when the user submits the chat input, send the message to the backend server
            function sendMessage(event) {
                
                var message = document.getElementById('chat_input').value;
                if (message != '') {
                    chat_input.value = '';
                    chatLog += message + "\n";
                    document.getElementById('chat_output').value += 'You: ' + message + '\n';
                    if (socketConnected) {
                        socket.send(message);
                    } else {
                        alert('You are not connected to the backend server. Please refresh the page. Or check that the backend server is running and all is configured properly.');
                    }
                } else {
                    alert('Please enter a message.');
                }
            }

            // function to keep websocket connection alive to prevent timeout
            function keepAlive() {
                if (socketConnected) {
                    socket.send('');
                }
            }

            // set an interval to keep the websocket connection alive
            setInterval(keepAlive(), 30000);
        </script>
    </head>
    <body>
        <div>
            <textarea id="chat_output" readonly></textarea>
        </div>
        <div>
            <textarea id="chat_input" placeholder="Type your message here..."></textarea>
        </div>
        <div>
            <button id="chat_button" onclick="sendMessage()">Send</button>
        </div>
    </body>
</html>